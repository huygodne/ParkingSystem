<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Parking System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-2 d-none d-md-block bg-light sidebar">
        <div class="position-sticky">
          <h4 class="text-center mt-3">Menu</h4>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link " href="#" id="statusNav">Parking Status</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#" id="historyNav">Parking History</a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Main content area -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="container shadow rounded bg-light">
          <h1 class="text-primary text-center mb-4">Smart Parking System</h1>

          <!-- Status Slots and Info Boxes -->
          <div id="statusContainer" class="slot-container" style="display: flex;">
            <!-- Info Boxes Container -->
            <div class="info-box-container">
              <div class="info-box total-slots">
                <h5>Total Slots</h5>
                <p id="totalSlots">3</p>
              </div>
              
              <div class="info-box available-slots">
                <h5>Available Slots</h5>
                <p id="availableSlots">2</p>
              </div>
              
              <div class="info-box remaining-slots">
                <h5>Remaining Slots</h5>
                <p id="remainingSlots">1</p>
              </div>              
            </div>

            <!-- Slot items will be dynamically added here -->
          </div>

          <!-- History Table -->
          <div id="historyTable" class="mt-3" style="display: none;">
            <h3 class="text-center">Parking History</h3>
            <table class="table table-striped table-bordered">
              <thead class="table-secondary">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Slot ID</th>
                  <th scope="col">Time In</th>
                  <th scope="col">Time Out</th>
                  <th scope="col">Total Time</th>
                </tr>
              </thead>
              <tbody id="history">
                <!-- History data will appear here -->
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // WebSocket setup
    const socket = new WebSocket('ws://localhost:3000');
    socket.onopen = () => console.log("WebSocket connected.");
    socket.onerror = error => alert("WebSocket connection failed.");
    socket.onclose = () => console.log("WebSocket connection closed.");

    // Display slot status with images from WebSocket data
    socket.onmessage = (event) => {
      const slots = JSON.parse(event.data);
      const statusContainer = document.getElementById('statusContainer');
      statusContainer.innerHTML = '';  // Clear previous slots

      // Add Info Boxes back into the container after clearing it
      const infoBoxContainer = document.createElement('div');
      infoBoxContainer.className = 'info-box-container';
      infoBoxContainer.innerHTML = `
        <div class="info-box">
          <h5>Total Slots</h5>
          <p id="totalSlots">3</p>
        </div>
        <div class="info-box">
          <h5>Available Slots</h5>
          <p id="availableSlots">2</p>
        </div>
        <div class="info-box">
          <h5>Remaining Slots</h5>
          <p id="remainingSlots">1</p>
        </div>
      `;
      statusContainer.appendChild(infoBoxContainer);

      // Add the slots into the container
      slots.slice(0, 3).forEach(slot => {
        const slotDiv = document.createElement('div');
        slotDiv.className = `slot ${slot.status === 0 ? 'available' : 'occupied'}`;

        slotDiv.innerHTML = `
          <img src="car.png" alt="Car Icon">
          <div class="slot-label">${slot.status === 0 ? 'Available' : 'Occupied'}</div>
        `;

        statusContainer.appendChild(slotDiv);
      });

      // Update available and remaining slots
      const totalSlots = slots.length;
      const availableSlots = slots.filter(slot => slot.status === 0).length;
      const remainingSlots = totalSlots - availableSlots;

      document.getElementById('totalSlots').textContent = totalSlots;
      document.getElementById('availableSlots').textContent = availableSlots;
      document.getElementById('remainingSlots').textContent = remainingSlots;
    };

    // Fetch parking history data
    function fetchHistory() {
      fetch('/api/history')
        .then(response => response.json())
        .then(data => {
          const historyTable = document.getElementById('history');
          historyTable.innerHTML = '';  // Clear previous data

          // Limit the data to the last 10 entries
          const latestHistory = data.slice(-10);

          latestHistory.forEach(entry => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${entry.id}</td>
              <td>${entry.slotId}</td>
              <td>${entry.timeIn}</td>
              <td>${entry.timeOut}</td>
              <td>${entry.totalTime}</td>
            `;
            historyTable.appendChild(row);
          });
        })
        .catch(err => console.error('Error fetching history:', err));
    }

    // Toggle between Status and History views
    document.getElementById('statusNav').addEventListener('click', () => {
      // Remove 'active' class from all menu items
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // Add 'active' class to the selected menu item
      document.getElementById('statusNav').classList.add('active');
      
      // Show the status container and hide the history table
      document.getElementById('statusContainer').style.display = 'flex';
      document.getElementById('historyTable').style.display = 'none';
    });

    document.getElementById('historyNav').addEventListener('click', () => {
      // Remove 'active' class from all menu items
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // Add 'active' class to the selected menu item
      document.getElementById('historyNav').classList.add('active');
      
      // Hide the status container and show the history table
      document.getElementById('statusContainer').style.display = 'none';
      document.getElementById('historyTable').style.display = 'block';
      fetchHistory(); // Fetch and display parking history
    });

  </script>
</body>
</html>

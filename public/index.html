<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Parking System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5 p-4 shadow rounded bg-light">
    <h1 class="text-primary text-center mb-4">Smart Parking System</h1>

    <!-- Nút chuyển giữa trang Status và History -->
    <div class="text-center mb-3">
      <button id="statusBtn" class="btn btn-primary me-2">Status</button>
      <button id="historyBtn" class="btn btn-secondary">History</button>
    </div>

    <!-- Bảng Status -->
    <div id="statusTable" class="mt-3">
      <h3 class="text-center">Parking Slot Status</h3>
      <table class="table table-striped table-bordered">
        <thead class="table-primary">
          <tr>
            <th scope="col">Slot</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody id="slots">
          <!-- Dữ liệu slot sẽ hiện ở đây -->
        </tbody>
      </table>
    </div>

    <!-- Bảng Lịch sử -->
    <div id="historyTable" class="mt-3" style="display: none;">
      <h3 class="text-center">Parking History</h3>
      <table class="table table-striped table-bordered">
        <thead class="table-secondary">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Slot ID</th>
            <th scope="col">Time In</th>
            <th scope="col">Time Out</th>
            <th scope="col">Total Time</th>
          </tr>
        </thead>
        <tbody id="history">
          <!-- Lịch sử đỗ xe sẽ hiện ở đây -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Nhận dạng kết nối WebSocket
    const socket = new WebSocket('ws://localhost:3000');

    socket.onopen = () => {
      console.log("WebSocket connected.");
    };

    socket.onerror = (error) => {
      console.error("WebSocket Error: ", error);
      alert("WebSocket connection failed.");
    };

    socket.onclose = () => {
      console.log("WebSocket connection closed.");
    };

    // Phần từ để chuyển đổi giữa các bảng
    const statusBtn = document.getElementById('statusBtn');
    const historyBtn = document.getElementById('historyBtn');
    const statusTable = document.getElementById('statusTable');
    const historyTable = document.getElementById('historyTable');

    // Chuyển đổi giữa Status và History
    statusBtn.addEventListener('click', () => {
      statusTable.style.display = 'block';
      historyTable.style.display = 'none';
      fetchStatus();  
    });

    historyBtn.addEventListener('click', () => {
      statusTable.style.display = 'none';
      historyTable.style.display = 'block';
      fetchHistory();  
    });

    // Hàm hiển thị slot status bằng websocket
    socket.onmessage = (event) => {
      const slots = JSON.parse(event.data);
      const slotsTable = document.getElementById('slots');
      slotsTable.innerHTML = '';  // Xóa dữ liệu cũ

      // Hiển thị 3 slot
      slots.slice(0, 3).forEach(slot => {
        const row = document.createElement('tr');
        row.innerHTML = ` 
          <td>${slot.slot}</td>
          <td class="${slot.status === 0 ? 'text-success' : 'text-danger'}">
            ${slot.status === 0 ? 'Available' : 'Occupied'}
          </td>
        `;
        slotsTable.appendChild(row);
      });
    };

    // Hàm để lấy lịch sử bãi đỗ
    function fetchHistory() {
      fetch('/api/history')
        .then(response => response.json())
        .then(data => {
          const historyTable = document.getElementById('history');
          historyTable.innerHTML = '';  // Xóa dữ liệu cũ

          // Hiển thị lịch sử đỗ xe
          data.forEach(entry => {
            const row = document.createElement('tr');
            const timeIn = entry.timeIn;  
            const timeOut = entry.timeOut ? entry.timeOut : 'Still Parked';
            const totalTime = entry.totalTime;

            row.innerHTML = `
              <td>${entry.id}</td>
              <td>${entry.slotId}</td>
              <td>${timeIn}</td>
              <td>${timeOut}</td>
              <td>${totalTime}</td>
            `;
            historyTable.appendChild(row);
          });
        }).catch(error => {
          console.error("Error fetching parking history:", error);
          alert("Failed to load parking history.");
        });
    }

  </script>
</body>
</html>
